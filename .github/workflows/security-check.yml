name: ğŸ”’ Security Check - MussikOn

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Ejecutar diariamente a las 2:00 AM UTC
    - cron: '0 2 * * *'

jobs:
  security-check:
    name: ğŸ” VerificaciÃ³n de Seguridad
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      with:
        # Solo acceder a documentaciÃ³n pÃºblica
        sparse-checkout: |
          docs/
          README.md
          LICENSE.md
          .github/
          !src/
          !app/
          !components/
          !screens/
          !services/
          !utils/
          !hooks/
          !contexts/
          !store/
          !config/
          !types/
          !appTypes/
          !package.json
          !tsconfig.json
          !app.json
          !metro.config.js
          !babel.config.js
          !.env*

    - name: ğŸ” Verificar ProtecciÃ³n de CÃ³digo
      run: |
        echo "ğŸ”’ Verificando protecciÃ³n del cÃ³digo fuente..."
        
        # Verificar que archivos sensibles no estÃ©n expuestos
        if [ -d "src" ]; then
          echo "âŒ ERROR: CÃ³digo fuente expuesto en /src/"
          exit 1
        fi
        
        if [ -f "package.json" ]; then
          echo "âŒ ERROR: package.json expuesto"
          exit 1
        fi
        
        if [ -f "app.json" ]; then
          echo "âŒ ERROR: app.json expuesto"
          exit 1
        fi
        
        echo "âœ… CÃ³digo fuente protegido correctamente"

    - name: ğŸ“š Verificar DocumentaciÃ³n PÃºblica
      run: |
        echo "ğŸ“š Verificando documentaciÃ³n pÃºblica..."
        
        # Verificar que la documentaciÃ³n estÃ© disponible
        if [ ! -d "docs" ]; then
          echo "âŒ ERROR: DocumentaciÃ³n no encontrada"
          exit 1
        fi
        
        if [ ! -f "README.md" ]; then
          echo "âŒ ERROR: README.md no encontrado"
          exit 1
        fi
        
        if [ ! -f "LICENSE.md" ]; then
          echo "âŒ ERROR: LICENSE.md no encontrado"
          exit 1
        fi
        
        echo "âœ… DocumentaciÃ³n pÃºblica disponible"

    - name: ğŸ” Verificar ConfiguraciÃ³n de Seguridad
      run: |
        echo "ğŸ” Verificando configuraciÃ³n de seguridad..."
        
        # Verificar archivos de configuraciÃ³n de seguridad
        if [ ! -f ".github/CODE_ACCESS_POLICY.md" ]; then
          echo "âŒ ERROR: PolÃ­tica de acceso al cÃ³digo no encontrada"
          exit 1
        fi
        
        if [ ! -f ".gitignore" ]; then
          echo "âŒ ERROR: .gitignore no encontrado"
          exit 1
        fi
        
        echo "âœ… ConfiguraciÃ³n de seguridad correcta"

    - name: ğŸ“‹ Generar Reporte de Seguridad
      run: |
        echo "ğŸ“‹ Generando reporte de seguridad..."
        
        echo "## ğŸ”’ Reporte de Seguridad - MussikOn" > security-report.md
        echo "" >> security-report.md
        echo "**Fecha**: $(date)" >> security-report.md
        echo "**Estado**: âœ… SEGURO" >> security-report.md
        echo "" >> security-report.md
        echo "### âœ… Verificaciones Exitosas:" >> security-report.md
        echo "- CÃ³digo fuente protegido" >> security-report.md
        echo "- DocumentaciÃ³n pÃºblica disponible" >> security-report.md
        echo "- ConfiguraciÃ³n de seguridad correcta" >> security-report.md
        echo "- Licencia de uso restringido activa" >> security-report.md
        echo "" >> security-report.md
        echo "### ğŸ“Š EstadÃ­sticas:" >> security-report.md
        echo "- Archivos protegidos: $(find . -name "*.ts" -o -name "*.tsx" -o -name "*.js" -o -name "*.jsx" | wc -l)" >> security-report.md
        echo "- Documentos pÃºblicos: $(find docs -name "*.md" | wc -l)" >> security-report.md
        echo "- PolÃ­ticas de seguridad: $(find .github -name "*.md" | wc -l)" >> security-report.md

    - name: ğŸ“¤ Subir Reporte de Seguridad
      uses: actions/upload-artifact@v4
      with:
        name: security-report
        path: security-report.md

  license-check:
    name: ğŸ“œ VerificaciÃ³n de Licencia
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4

    - name: ğŸ” Verificar Licencia
      run: |
        echo "ğŸ“œ Verificando licencia de uso restringido..."
        
        if [ ! -f "LICENSE.md" ]; then
          echo "âŒ ERROR: LICENSE.md no encontrado"
          exit 1
        fi
        
        # Verificar que la licencia contenga tÃ©rminos de uso restringido
        if ! grep -q "PROHIBIDO.*uso comercial" LICENSE.md; then
          echo "âŒ ERROR: Licencia no contiene prohibiciÃ³n de uso comercial"
          exit 1
        fi
        
        if ! grep -q "CÃ³digo fuente.*RESTRINGIDO" LICENSE.md; then
          echo "âŒ ERROR: Licencia no protege el cÃ³digo fuente"
          exit 1
        fi
        
        echo "âœ… Licencia de uso restringido correcta"

  documentation-check:
    name: ğŸ“š VerificaciÃ³n de DocumentaciÃ³n
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4

    - name: ğŸ” Verificar DocumentaciÃ³n
      run: |
        echo "ğŸ“š Verificando documentaciÃ³n pÃºblica..."
        
        # Verificar archivos de documentaciÃ³n principales
        required_docs=("README.md" "LICENSE.md" "docs/INDEX.md" "docs/DOCUMENTATION_SUMMARY.md")
        
        for doc in "${required_docs[@]}"; do
          if [ ! -f "$doc" ]; then
            echo "âŒ ERROR: $doc no encontrado"
            exit 1
          fi
        done
        
        # Verificar estructura de documentaciÃ³n
        if [ ! -d "docs" ]; then
          echo "âŒ ERROR: Carpeta docs no encontrada"
          exit 1
        fi
        
        echo "âœ… DocumentaciÃ³n pÃºblica completa"

    - name: ğŸ“Š Generar EstadÃ­sticas de DocumentaciÃ³n
      run: |
        echo "ğŸ“Š Generando estadÃ­sticas de documentaciÃ³n..."
        
        echo "## ğŸ“š EstadÃ­sticas de DocumentaciÃ³n" > docs-stats.md
        echo "" >> docs-stats.md
        echo "**Fecha**: $(date)" >> docs-stats.md
        echo "" >> docs-stats.md
        echo "### ğŸ“ Archivos de DocumentaciÃ³n:" >> docs-stats.md
        echo "- README.md: $(wc -l < README.md) lÃ­neas" >> docs-stats.md
        echo "- LICENSE.md: $(wc -l < LICENSE.md) lÃ­neas" >> docs-stats.md
        echo "- docs/INDEX.md: $(wc -l < docs/INDEX.md) lÃ­neas" >> docs-stats.md
        echo "- docs/DOCUMENTATION_SUMMARY.md: $(wc -l < docs/DOCUMENTATION_SUMMARY.md) lÃ­neas" >> docs-stats.md
        echo "" >> docs-stats.md
        echo "### ğŸ“‚ Estructura de DocumentaciÃ³n:" >> docs-stats.md
        find docs -name "*.md" | wc -l | xargs echo "- Total archivos .md: " >> docs-stats.md
        echo "- Carpetas de documentaciÃ³n: $(find docs -type d | wc -l)" >> docs-stats.md

    - name: ğŸ“¤ Subir EstadÃ­sticas de DocumentaciÃ³n
      uses: actions/upload-artifact@v4
      with:
        name: documentation-stats
        path: docs-stats.md

  notify-security:
    name: ğŸ“¢ NotificaciÃ³n de Seguridad
    runs-on: ubuntu-latest
    needs: [security-check, license-check, documentation-check]
    if: always()
    
    steps:
    - name: ğŸ“§ Enviar NotificaciÃ³n
      run: |
        echo "ğŸ“¢ Enviando notificaciÃ³n de estado de seguridad..."
        
        if [ "${{ needs.security-check.result }}" == "success" ] && \
           [ "${{ needs.license-check.result }}" == "success" ] && \
           [ "${{ needs.documentation-check.result }}" == "success" ]; then
          echo "âœ… Todas las verificaciones de seguridad exitosas"
          echo "ğŸ”’ CÃ³digo fuente protegido correctamente"
          echo "ğŸ“š DocumentaciÃ³n pÃºblica disponible"
          echo "ğŸ“œ Licencia de uso restringido activa"
        else
          echo "âŒ Algunas verificaciones de seguridad fallaron"
          echo "ğŸ” Revisar logs para mÃ¡s detalles"
        fi 